---
title: "che"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{che}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Working example of using Convex Hull Ensembles and range bagging with the `che` package
## Matt Hill 2019

```{r setup}
library(che)
library (raster)
library (maptools)
library (rgeos)

# simple world outline from maptools package
data("wrld_simpl")
```

## this data is the in the `che` package - will implement neater soon....
```{r}
load("../data/insect_dist.Rdata")
```

## Bioclim data
```{r}
bioclimall <- raster::getData('worldclim', var='bio', res=2.5)
```


# Background creation

## Native range for this species is South Africa
```{r}
e <- extent (10, 40, -35, -15)
SAfrica <- crop (bioclimall, e)
#convert to a stack
SAfrica <- stack(unstack(SAfrica))
```

## Species data

### Halotydeus destructor
```{r fig.width=5, fig.height=5}
dist <- insect_dist[insect_dist$Species =="h_destructor" & insect_dist$Range == "Native",]

sp_df <- cbind(as.data.frame(dist[,c("Longitude", "Latitude")]),raster::extract(SAfrica, as.data.frame(dist[,c("Longitude", "Latitude")])))
plot (SAfrica[[1]])
points(as.data.frame(dist[,c("Longitude", "Latitude")]), pch=20)
```

## Biomes

The biomes are available as a shapefile from WWF
```{r}

if (!file.exists("official/wwf_terr_ecos.shp")){
  temp <- tempfile()
  download.file("https://c402277.ssl.cf1.rackcdn.com/publications/15/files/original/official_teow.zip",temp)
  unzip(temp)
  unlink(temp)
}
terres <- readShapePoly("official/wwf_terr_ecos.shp")
```


## Create a raster using biomes and native range points

Using the `che::background_builder` function to set up sampling environment

```{r fig.width= 5, fig.height=5}
clim <- cbind(as.data.frame(dist[,c("Longitude", "Latitude")]),raster::extract(SAfrica, as.data.frame(dist[,c("Longitude", "Latitude")])))

nat_ras <- background_builder(distrib=clim, 
                              terres=terres,
                              wrld_simpl= wrld_simpl, 
                              ref_rast = bioclimall[[1]])

plot (nat_ras)
```

Using the `che::prepare_data` function to prepare the data for the modelling process
```{r}

model.data <- prepare_data(rasters=bioclimall, mask_raster=nat_ras, predict.to=SAfrica, 
             spp.dist=clim[,1:2], w.val=1.e-6, bg.sample = 50000)
```

## Parallel processing of GAMs
```{r}

# input 

# predict.to <- model.data$predict.to
# PA <- model.data$PA
# PA2 <- model.data$PA2
# pbg.which <- model.data$pbg.which
# w <- model.data$w
# natptsall <- model.data$natptsall
# pbgwhich <- model.data$pbg.which
# backall <- model.data$backall

model.out <- che_model(spp = "h_destuctor", parallel = TRUE, model.data=model.data)


# varsStack <- stack()
# convStack <- stack()
# AUC.result <- list()
# 

# 
# if (parallel==TRUE){
# 
# require(parallel)
# 
# n.cores <- detectCores() - 1
# cl <- makeCluster(n.cores, type="FORK", methods=F)
# clusterExport(cl=cl, varlist=c('predict.to', 'convStack', 'PA', 'PA2', 'w', 'natptsall', 'pbg.which', 'backall', 'AUC.result'))
# clusterEvalQ(cl, {
#   require(methods)
#   require(AUC)
#   require(dismo)
#   require(mgcv)})
# 
# # Run models on the cluster (cl), for variables (j) using the runGams function...
# test <- parLapply(cl, 12:19, runCHE)
# stopCluster(cl)
# } else{
# 
#   for (k in 12:19){
#     runCHE(k)
#     ## add list
# }
# 
# }


```
## Reconcile outputs

```{r}


## just reset these all first
AUC.result <- list()
convStack <- stack()
varStack <- stack ()

for (i in 1:8){
  convStack <- stack(convStack, model.out[[i]][[1]])
  varsStack <- stack(varsStack, model.out[[i]][[2]])

  temp.AUC <- unlist(model.out[[i]][[3]])
  AUC.result[[i]] <- temp.AUC

}


AUC.result <- unlist(AUC.result)

quantile_thresh <- (quantile (AUC.result, 0.25))
keep_AUC <- AUC.result[AUC.result > quantile_thresh]
keep_AUC <- tibble::rownames_to_column(as.data.frame(keep_AUC))


q_CHE <- sum_stack(convStack,keep_AUC[,1])

plot (q_CHE)
points(dist[,c("Longitude", "Latitude")], pch=20)

```

